{"version":3,"file":"index.js","sources":["../../../src/vite/plugins/workspace-resolver.ts"],"sourcesContent":["import { readdirSync, readFileSync, statSync } from 'node:fs';\nimport { join, resolve } from 'node:path';\nimport type { Plugin } from 'vite';\n\nimport type { WorkspaceResolverOptions } from '../@types/workspace-resolver.types';\n\nexport function workspaceResolver(options: WorkspaceResolverOptions = {}): Plugin {\n  // Auto-derive workspace root - look for workspaces directory in current or parent directories\n  const findWorkspaceRoot = (): string => {\n    let cwd = process.cwd();\n\n    // Check current directory and parents for workspaces folder\n    while (cwd !== '/') {\n      const workspacesPath = join(cwd, 'workspaces');\n      try {\n        if (statSync(workspacesPath).isDirectory()) {\n          return workspacesPath;\n        }\n      } catch {}\n      cwd = resolve(cwd, '..');\n    }\n\n    // Fallback to conventional path from cwd\n    return join(process.cwd(), 'workspaces');\n  };\n\n  const defaultWorkspaceRoot = findWorkspaceRoot();\n  const defaultWorkspacePath = join(defaultWorkspaceRoot, ':PKG:/src/:SUBPATH:');\n\n  const { workspacePath = defaultWorkspacePath, exclude = true, workspaceDirs } = options;\n\n  const workspaceRoot = workspacePath.replace('/:PKG:/src/:SUBPATH:', '');\n\n  // Auto-derive prefix by scanning workspace packages\n  let prefix = options.prefix;\n  if (!prefix) {\n    prefix = derivePrefix();\n  }\n  const packageCache = new Map<string, { exports?: Record<string, unknown>; [key: string]: unknown }>();\n  const discoveredWorkspacePackages = new Set<string>();\n\n  function getPackageExports(pkgName: string) {\n    if (packageCache.has(pkgName)) {\n      return packageCache.get(pkgName);\n    }\n\n    try {\n      const packageJsonPath = join(workspaceRoot, pkgName, 'package.json');\n      const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));\n      const exports = packageJson.exports || {};\n      packageCache.set(pkgName, exports);\n      return exports;\n    } catch (_e) {\n      packageCache.set(pkgName, {});\n      return {};\n    }\n  }\n\n  function derivePrefix(): string {\n    try {\n      const discoveredDirs = getWorkspaceDirs();\n      for (const dir of discoveredDirs) {\n        try {\n          const packageJsonPath = join(workspaceRoot, dir, 'package.json');\n          const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));\n          if (packageJson.name?.includes('/')) {\n            const scope = packageJson.name.split('/')[0];\n            return `${scope}/`;\n          }\n        } catch {}\n      }\n    } catch {\n      // Fallback to common default\n    }\n    return '@workspace/';\n  }\n\n  function getWorkspaceDirs(): string[] {\n    if (workspaceDirs) {\n      return workspaceDirs;\n    }\n\n    try {\n      // Auto-discover workspace directories\n      const entries = readdirSync(workspaceRoot);\n      return entries.filter(entry => {\n        try {\n          const fullPath = join(workspaceRoot, entry);\n          const stat = statSync(fullPath);\n          if (!stat.isDirectory()) return false;\n\n          // Check if directory contains package.json\n          const packageJsonPath = join(fullPath, 'package.json');\n          return statSync(packageJsonPath).isFile();\n        } catch {\n          return false;\n        }\n      });\n    } catch {\n      return [];\n    }\n  }\n\n  function discoverWorkspacePackages() {\n    const workspacePackages: string[] = [];\n\n    try {\n      const discoveredWorkspaceDirs = getWorkspaceDirs();\n\n      for (const dir of discoveredWorkspaceDirs) {\n        try {\n          const packageJsonPath = join(workspaceRoot, dir, 'package.json');\n          const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf-8'));\n          if (packageJson.name?.startsWith(prefix?.replace(/\\/$/, ''))) {\n            const exports = packageJson.exports || {};\n\n            // Add main package\n            workspacePackages.push(packageJson.name);\n\n            // Add all sub-exports\n            for (const exportKey of Object.keys(exports)) {\n              if (exportKey !== './package.json' && exportKey !== '.') {\n                const fullExportName = `${packageJson.name}${exportKey.replace('.', '')}`;\n                workspacePackages.push(fullExportName);\n              }\n            }\n          }\n        } catch (_e) {\n          // Skip if package.json doesn't exist or is invalid\n        }\n      }\n    } catch (_e) {\n      // Fallback to empty array if discovery fails\n    }\n\n    return workspacePackages;\n  }\n\n  return {\n    name: 'workspace-resolver',\n\n    configResolved(config) {\n      if (exclude) {\n        const workspacePackages = discoverWorkspacePackages();\n\n        // Ensure optimizeDeps.exclude exists\n        if (!config.optimizeDeps) {\n          // biome-ignore lint/suspicious/noExplicitAny: acceptable\n          (config as any).optimizeDeps = {};\n        }\n        if (!config.optimizeDeps.exclude) {\n          config.optimizeDeps.exclude = [];\n        }\n\n        // Add workspace packages to exclude list (only workspace packages, not their dependencies)\n        for (const pkg of workspacePackages) {\n          if (!config.optimizeDeps.exclude.includes(pkg)) {\n            config.optimizeDeps.exclude.push(pkg);\n          }\n        }\n\n        console.info(`[workspace-resolver] Excluded ${workspacePackages.length} workspace packages from optimization`);\n        console.info('[workspace-resolver] All dependencies will be pre-bundled normally by Vite');\n      }\n    },\n\n    resolveId(id) {\n      if (id.startsWith(prefix)) {\n        try {\n          const [_scope, pkg = '', ...subpath] = id.split('/');\n          discoveredWorkspacePackages.add(`${prefix.replace(/\\/$/, '')}/${pkg}`);\n\n          const packageExports = getPackageExports(pkg);\n\n          // Reconstruct the export key\n          const exportKey = subpath.length > 0 ? `./${subpath.join('/')}` : '.';\n\n          // Check if this exact export exists\n          if (packageExports[exportKey]) {\n            const exportValue = packageExports[exportKey];\n            let sourcePath: string | undefined;\n\n            if (typeof exportValue === 'string') {\n              sourcePath = exportValue;\n            } else if (typeof exportValue === 'object' && exportValue && 'default' in exportValue) {\n              sourcePath = exportValue.default;\n            }\n\n            if (sourcePath?.startsWith('./src/')) {\n              const resolvedPath = resolve(workspaceRoot, pkg, sourcePath.replace('./', ''));\n              // Verify the resolved path exists before returning\n              try {\n                statSync(resolvedPath);\n                return resolvedPath;\n              } catch {\n                // Fall through to fallback resolution\n              }\n            }\n          }\n\n          // Fallback to basic path resolution for files not in exports\n          const fallbackPath = join(workspaceRoot, pkg, 'src', subpath.join('/'));\n\n          // If no subpath, try to find index file\n          if (subpath.length === 0) {\n            return `${fallbackPath}/index.ts`;\n          }\n\n          return fallbackPath;\n        } catch (error) {\n          // Log error but don't throw - let Vite handle the resolution failure\n          console.warn(`[workspace-resolver] Failed to resolve ${id}:`, error);\n          return null;\n        }\n      }\n    },\n  };\n}\n"],"names":[],"mappings":";;AAMO,SAAS,kBAAkB,UAAoC,IAAY;AAEhF,QAAM,oBAAoB,MAAc;AACtC,QAAI,MAAM,QAAQ,IAAA;AAGlB,WAAO,QAAQ,KAAK;AAClB,YAAM,iBAAiB,KAAK,KAAK,YAAY;AAC7C,UAAI;AACF,YAAI,SAAS,cAAc,EAAE,eAAe;AAC1C,iBAAO;AAAA,QACT;AAAA,MACF,QAAQ;AAAA,MAAC;AACT,YAAM,QAAQ,KAAK,IAAI;AAAA,IACzB;AAGA,WAAO,KAAK,QAAQ,IAAA,GAAO,YAAY;AAAA,EACzC;AAEA,QAAM,uBAAuB,kBAAA;AAC7B,QAAM,uBAAuB,KAAK,sBAAsB,qBAAqB;AAE7E,QAAM,EAAE,gBAAgB,sBAAsB,UAAU,MAAM,kBAAkB;AAEhF,QAAM,gBAAgB,cAAc,QAAQ,wBAAwB,EAAE;AAGtE,MAAI,SAAS,QAAQ;AACrB,MAAI,CAAC,QAAQ;AACX,aAAS,aAAA;AAAA,EACX;AACA,QAAM,mCAAmB,IAAA;AACzB,QAAM,kDAAkC,IAAA;AAExC,WAAS,kBAAkB,SAAiB;AAC1C,QAAI,aAAa,IAAI,OAAO,GAAG;AAC7B,aAAO,aAAa,IAAI,OAAO;AAAA,IACjC;AAEA,QAAI;AACF,YAAM,kBAAkB,KAAK,eAAe,SAAS,cAAc;AACnE,YAAM,cAAc,KAAK,MAAM,aAAa,iBAAiB,OAAO,CAAC;AACrE,YAAM,UAAU,YAAY,WAAW,CAAA;AACvC,mBAAa,IAAI,SAAS,OAAO;AACjC,aAAO;AAAA,IACT,SAAS,IAAI;AACX,mBAAa,IAAI,SAAS,EAAE;AAC5B,aAAO,CAAA;AAAA,IACT;AAAA,EACF;AAEA,WAAS,eAAuB;AAC9B,QAAI;AACF,YAAM,iBAAiB,iBAAA;AACvB,iBAAW,OAAO,gBAAgB;AAChC,YAAI;AACF,gBAAM,kBAAkB,KAAK,eAAe,KAAK,cAAc;AAC/D,gBAAM,cAAc,KAAK,MAAM,aAAa,iBAAiB,OAAO,CAAC;AACrE,cAAI,YAAY,MAAM,SAAS,GAAG,GAAG;AACnC,kBAAM,QAAQ,YAAY,KAAK,MAAM,GAAG,EAAE,CAAC;AAC3C,mBAAO,GAAG,KAAK;AAAA,UACjB;AAAA,QACF,QAAQ;AAAA,QAAC;AAAA,MACX;AAAA,IACF,QAAQ;AAAA,IAER;AACA,WAAO;AAAA,EACT;AAEA,WAAS,mBAA6B;AACpC,QAAI,eAAe;AACjB,aAAO;AAAA,IACT;AAEA,QAAI;AAEF,YAAM,UAAU,YAAY,aAAa;AACzC,aAAO,QAAQ,OAAO,CAAA,UAAS;AAC7B,YAAI;AACF,gBAAM,WAAW,KAAK,eAAe,KAAK;AAC1C,gBAAM,OAAO,SAAS,QAAQ;AAC9B,cAAI,CAAC,KAAK,YAAA,EAAe,QAAO;AAGhC,gBAAM,kBAAkB,KAAK,UAAU,cAAc;AACrD,iBAAO,SAAS,eAAe,EAAE,OAAA;AAAA,QACnC,QAAQ;AACN,iBAAO;AAAA,QACT;AAAA,MACF,CAAC;AAAA,IACH,QAAQ;AACN,aAAO,CAAA;AAAA,IACT;AAAA,EACF;AAEA,WAAS,4BAA4B;AACnC,UAAM,oBAA8B,CAAA;AAEpC,QAAI;AACF,YAAM,0BAA0B,iBAAA;AAEhC,iBAAW,OAAO,yBAAyB;AACzC,YAAI;AACF,gBAAM,kBAAkB,KAAK,eAAe,KAAK,cAAc;AAC/D,gBAAM,cAAc,KAAK,MAAM,aAAa,iBAAiB,OAAO,CAAC;AACrE,cAAI,YAAY,MAAM,WAAW,QAAQ,QAAQ,OAAO,EAAE,CAAC,GAAG;AAC5D,kBAAM,UAAU,YAAY,WAAW,CAAA;AAGvC,8BAAkB,KAAK,YAAY,IAAI;AAGvC,uBAAW,aAAa,OAAO,KAAK,OAAO,GAAG;AAC5C,kBAAI,cAAc,oBAAoB,cAAc,KAAK;AACvD,sBAAM,iBAAiB,GAAG,YAAY,IAAI,GAAG,UAAU,QAAQ,KAAK,EAAE,CAAC;AACvE,kCAAkB,KAAK,cAAc;AAAA,cACvC;AAAA,YACF;AAAA,UACF;AAAA,QACF,SAAS,IAAI;AAAA,QAEb;AAAA,MACF;AAAA,IACF,SAAS,IAAI;AAAA,IAEb;AAEA,WAAO;AAAA,EACT;AAEA,SAAO;AAAA,IACL,MAAM;AAAA,IAEN,eAAe,QAAQ;AACrB,UAAI,SAAS;AACX,cAAM,oBAAoB,0BAAA;AAG1B,YAAI,CAAC,OAAO,cAAc;AAEvB,iBAAe,eAAe,CAAA;AAAA,QACjC;AACA,YAAI,CAAC,OAAO,aAAa,SAAS;AAChC,iBAAO,aAAa,UAAU,CAAA;AAAA,QAChC;AAGA,mBAAW,OAAO,mBAAmB;AACnC,cAAI,CAAC,OAAO,aAAa,QAAQ,SAAS,GAAG,GAAG;AAC9C,mBAAO,aAAa,QAAQ,KAAK,GAAG;AAAA,UACtC;AAAA,QACF;AAEA,gBAAQ,KAAK,iCAAiC,kBAAkB,MAAM,uCAAuC;AAC7G,gBAAQ,KAAK,4EAA4E;AAAA,MAC3F;AAAA,IACF;AAAA,IAEA,UAAU,IAAI;AACZ,UAAI,GAAG,WAAW,MAAM,GAAG;AACzB,YAAI;AACF,gBAAM,CAAC,QAAQ,MAAM,IAAI,GAAG,OAAO,IAAI,GAAG,MAAM,GAAG;AACnD,sCAA4B,IAAI,GAAG,OAAO,QAAQ,OAAO,EAAE,CAAC,IAAI,GAAG,EAAE;AAErE,gBAAM,iBAAiB,kBAAkB,GAAG;AAG5C,gBAAM,YAAY,QAAQ,SAAS,IAAI,KAAK,QAAQ,KAAK,GAAG,CAAC,KAAK;AAGlE,cAAI,eAAe,SAAS,GAAG;AAC7B,kBAAM,cAAc,eAAe,SAAS;AAC5C,gBAAI;AAEJ,gBAAI,OAAO,gBAAgB,UAAU;AACnC,2BAAa;AAAA,YACf,WAAW,OAAO,gBAAgB,YAAY,eAAe,aAAa,aAAa;AACrF,2BAAa,YAAY;AAAA,YAC3B;AAEA,gBAAI,YAAY,WAAW,QAAQ,GAAG;AACpC,oBAAM,eAAe,QAAQ,eAAe,KAAK,WAAW,QAAQ,MAAM,EAAE,CAAC;AAE7E,kBAAI;AACF,yBAAS,YAAY;AACrB,uBAAO;AAAA,cACT,QAAQ;AAAA,cAER;AAAA,YACF;AAAA,UACF;AAGA,gBAAM,eAAe,KAAK,eAAe,KAAK,OAAO,QAAQ,KAAK,GAAG,CAAC;AAGtE,cAAI,QAAQ,WAAW,GAAG;AACxB,mBAAO,GAAG,YAAY;AAAA,UACxB;AAEA,iBAAO;AAAA,QACT,SAAS,OAAO;AAEd,kBAAQ,KAAK,0CAA0C,EAAE,KAAK,KAAK;AACnE,iBAAO;AAAA,QACT;AAAA,MACF;AAAA,IACF;AAAA,EAAA;AAEJ;"}